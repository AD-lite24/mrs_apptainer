Bootstrap: docker
From: ros:noetic

%post

    apt-get -y update

    # fix prompts during installation
    echo 'debconf debconf/frontend select Noninteractive' | sudo debconf-set-selections
    sudo apt-get install -y -q
    DEBIAN_FRONTEND=noninteractive sudo apt-get -y install keyboard-configuration

    apt-get -y install git vim ranger zsh

    TARGET_LOCATION=/opt/mrs

    mkdir -p $TARGET_LOCATION

    # clone uav_core
    mkdir -p $TARGET_LOCATION/git
    cd $TARGET_LOCATION/git
    git clone https://github.com/ctu-mrs/mrs_uav_system
    cd mrs_uav_system
    git checkout general_installation
    ./install.sh -g /opt/mrs/git -l /opt/mrs

    cd $TARGET_LOCATION/mrs_uav_system && rm -rf build

    apt-get -y autoremove
    apt-get -y clean

    # create internal .bashrc
    touch $TARGET_LOCATION/singularity_bashrc.sh
    chmod +x $TARGET_LOCATION/singularity_bashrc.sh

    # Beware! The indentation in the following block has to be done with real <tab>
    cat <<- EOF > $TARGET_LOCATION/singularity_bashrc.sh
			#!/bin/bash

			if [ -e /opt/mrs/host/singularity_rcfile.sh ]; then
				echo "Sourcing singularity_rcfile.sh from mrs_singularity/mount/singularity_rcfile.sh"
				source "/opt/mrs/host/singularity_rcfile.sh"
			fi

		EOF

%environment

    export LC_ALL=C

%runscript

  if [ -z $1 ]; then
    exec /bin/bash --rcfile /opt/mrs/singularity_bashrc.sh
  else
    CMD="${@}"
    exec /bin/bash --rcfile /opt/mrs/singularity_bashrc.sh -c "${CMD}"
  fi
