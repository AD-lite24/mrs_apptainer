Bootstrap: docker
From: ros:noetic

%post

    apt-get -y update

    # fix prompts during installation
    echo 'debconf debconf/frontend select Noninteractive' | sudo debconf-set-selections
    sudo apt-get install -y -q
    DEBIAN_FRONTEND=noninteractive sudo apt-get -y install keyboard-configuration

    apt-get -y install git vim ranger zsh

    TARGET_LOCATION=/opt/mrs
    mkdir -p $TARGET_LOCATION

    # clone uav_core
    mkdir -p $TARGET_LOCATION/git
    cd $TARGET_LOCATION/git
    git clone https://github.com/ctu-mrs/mrs_uav_system
    cd mrs_uav_system
    git checkout general_installation
    ./install.sh -g $TARGET_LOCATION/git -l $TARGET_LOCATION

    cd $TARGET_LOCATION/mrs_uav_system && rm -rf build

    apt-get -y autoremove
    apt-get -y clean

    # Beware! The indentation in the following block has to be done with real <tab>
    cat <<- EOF > /.singularity.d/env/99-mrs_env.sh
			#!/bin/bash

			echo "sourcing env/99-mrs_env.sh start"

			# create /tmp tmux folder
			USER_ID=$( id -u )
			[ ! -e tmp/tmux-$USER_ID ] && mkdir -p /tmp/tmux-$USER_ID

			# link bash and zsh rc files
			[ ! -e ~/.bashrc ] && ln -s $TARGET_LOCATION/host/singularity_bashrc.sh ~/.bashrc
			[ ! -e ~/.zshrc ] && ln -s $TARGET_LOCATION/host/singularity_zshrc.sh ~/.zshrc

			# link .tmux.conf
			[ ! -e ~/.tmux.conf ] && ln -s $TARGET_LOCATION/mrs_workspace/src/uav_core/installation/dependencies/tmux/dottmux.conf ~/.tmux.conf

			export PS1="[MRS Singularity]\w \$ "

			export TERM='xterm-256color'

			echo "sourcing env/99-mrs_env.sh finished"
		EOF

%environment

    export LC_ALL=C

%runscript
  echo "%runscript started"

  if [ -z "$@" ]; then
    exec /bin/bash -i
  else
    exec /bin/bash -i -c "$@"
  fi

  echo "%runscript finished"
