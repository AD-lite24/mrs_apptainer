# bootstrap from docker hub
Bootstrap: docker
From: ctumrs/mrs_uav_system

# bootstrap from local machine
# Bootstrap: docker-daemon
# From: ctumrs/mrs_uav_system:latest

# bootstrap from local linux setup docker image
# Bootstrap: docker-daemon
# From: klaxalk/linux_setup:latest

%post
    INSTALL_LINUX_SETUP=true

    apt-get -y update

    # fix prompts during installation
    echo 'debconf debconf/frontend select Noninteractive' | sudo debconf-set-selections
    sudo apt-get install -y -q
    DEBIAN_FRONTEND=noninteractive sudo apt-get -y install keyboard-configuration

    apt-get -y install git

    if $INSTALL_LINUX_SETUP; then

      LINUX_SETUP_LOCATION=/opt/klaxalk/git
      mkdir -p $LINUX_SETUP_LOCATION
      cd $LINUX_SETUP_LOCATION
      git clone https://github.com/klaxalk/linux-setup
      cd linux-setup
      git checkout devel
      export PROFILES="COLORSCHEME_DARK"
      ./install.sh --unattended

    else

      apt-get -y install vim ranger tmux zsh

    fi

    TARGET_LOCATION=/opt/mrs
    mkdir -p $TARGET_LOCATION

    # Beware! The indentation in the following block has to be done with real <tab>
    cat <<- EOF > /.singularity.d/env/99-mrs_env.sh
			#!/bin/bash

      LINUX_SETUP_LOCATION=/opt/klaxalk/git

			# create /tmp tmux folder
			USER_ID=$( id -u )
			[ ! -e tmp/tmux-$USER_ID ] && mkdir -p /tmp/tmux-$USER_ID

			# the following section links config files for Tomas's Linux Setup

			# link bash and zsh rc files
			[ ! -e ~/.bashrc ] && [ -e $TARGET_LOCATION/host/singularity_bashrc.sh ] && ln -s $TARGET_LOCATION/host/singularity_bashrc.sh ~/.bashrc

			[ ! -e ~/.zshrc ] && [ -e $TARGET_LOCATION/host/singularity_zshrc.sh ] && ln -s $TARGET_LOCATION/host/singularity_zshrc.sh ~/.zshrc

			[ ! -e ~/.profile ] && [ -e $TARGET_LOCATION/host/singularity_profile.sh ] && ln -s $TARGET_LOCATION/host/singularity_profile.sh ~/.profile

			# link .tmux.conf
			[ ! -e ~/.tmux.conf ] && [ -e $TARGET_LOCATION/mrs_workspace/src/uav_core/installation/dependencies/tmux/dottmux.conf ] && ln -s $TARGET_LOCATION/mrs_workspace/src/uav_core/installation/dependencies/tmux/dottmux.conf ~/.tmux.conf

			# link .vim
			[ ! -e ~/.vim ] && [ -e $LINUX_SETUP_LOCATION/linux-setup/appconfig/vim/dotvim ] && ln -s $LINUX_SETUP_LOCATION/linux-setup/appconfig/vim/dotvim ~/.vim

			[ ! -e ~/.vimrc ] && [ -e $LINUX_SETUP_LOCATION/linux-setup/appconfig/vim/dotvimrc ] && ln -s $LINUX_SETUP_LOCATION/linux-setup/appconfig/vim/dotvimrc ~/.vimrc

			# link ranger
			[ ! -e ~/.config/ranger ] && mkdir -p ~/.config/ranger

			[ ! -e ~/.config/ranger/rigle.conf ] && [ -e $LINUX_SETUP_LOCATION/linux-setup/appconfig/ranger/rigle.conf ] && ln -s $LINUX_SETUP_LOCATION/linux-setup/appconfig/ranger/rigle.conf ~/.config/ranger/rigle.conf

			[ ! -e ~/.config/ranger/commands.py ] && [ -e $LINUX_SETUP_LOCATION/linux-setup/appconfig/ranger/commands.py ] && ln -s $LINUX_SETUP_LOCATION/linux-setup/appconfig/ranger/commands.py ~/.config/ranger/commands.py

			[ ! -e ~/.config/ranger/rc.conf ] && [ -e $LINUX_SETUP_LOCATION/linux-setup/appconfig/ranger/rc.conf ] && ln -s $LINUX_SETUP_LOCATION/linux-setup/appconfig/ranger/rc.conf ~/.config/ranger/rc.conf

			[ ! -e ~/.config/ranger/scope.sh ] && [ -e $LINUX_SETUP_LOCATION/linux-setup/appconfig/ranger/scope.sh ] && ln -s $LINUX_SETUP_LOCATION/linux-setup/appconfig/ranger/scope.sh ~/.config/ranger/scope.sh

			# link ycm extra conf
			[ ! -e ~/.ycm_extra_conf.py ] && [ -e $LINUX_SETUP_LOCATION/linux-setup/appconfig/vim/dotycm_extra_conf.py ] && ln -s $LINUX_SETUP_LOCATION/linux-setup/appconfig/vim/dotycm_extra_conf.py ~/.ycm_extra_conf.py

			export PS1="[MRS Singularity] ${debian_chroot:+($debian_chroot)}\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ "
		EOF

%environment
    export LC_ALL=C

%runscript
  CMD="${@}"

  if [ -z "${CMD}" ]; then
    exec /bin/bash --login
  else
    exec /bin/bash --login -c "${CMD}"
  fi
