Bootstrap: docker
From: ctumrs/mrs_uav_system

%post

    apt-get -y update

    # fix prompts during installation
    echo 'debconf debconf/frontend select Noninteractive' | sudo debconf-set-selections
    sudo apt-get install -y -q
    DEBIAN_FRONTEND=noninteractive sudo apt-get -y install keyboard-configuration

    apt-get -y install git vim ranger zsh

    TARGET_LOCATION=/opt/mrs

    # create internal .bashrc
    touch $TARGET_LOCATION/singularity_bashrc.sh
    chmod +x $TARGET_LOCATION/singularity_bashrc.sh

    # Beware! The indentation in the following block has to be done with real <tab>
    cat <<- EOF > $TARGET_LOCATION/singularity_bashrc.sh
			#!/bin/bash

			if [ -e /opt/mrs/host/singularity_bashrc.sh ]; then
				echo "Sourcing singularity_bashrc.sh from mrs_singularity/mount/singularity_bashrc.sh"
				source "/opt/mrs/host/singularity_bashrc.sh"
			fi

		EOF

    # Beware! The indentation in the following block has to be done with real <tab>
    cat <<- EOF > /.singularity.d/env/99-mrs_env.sh
			#!/bin/bash

			echo "sourcing custom env start"

			# create /tmp tmux folder
			USER_ID=$( id -u )
			[ ! -e "/tmp/tmux-$USER_ID" ] && mkdir -p "/tmp/tmux-$USER_ID"

			# link bash and zsh rc files
			[ ! -e "$HOME/.bashrc" ] && ln -s /opt/mrs/host/singularity_bashrc.sh $HOME/.bashrc
			[ ! -e "$HOME/.zshrc" ] && ln -s /opt/mrs/host/singularity_zshrc.sh $HOME/.zshrc

			# link .tmux.conf
			[ ! -e "$HOME/.tmux.conf" ] && ln -s /opt/mrs/mrs_workspace/src/uav_core/installation/dependencies/tmux/dottmux.conf $HOME/.tmux.conf

			echo "sourcing custom env finished"
		EOF

%environment

    export LC_ALL=C

%runscript
  echo "%runscript started"

  if [ -z $1 ]; then
    exec /bin/bash --rcfile /opt/mrs/singularity_bashrc.sh
  else
    CMD="${@}"
    exec /bin/bash --rcfile /opt/mrs/singularity_bashrc.sh -c "${CMD}"
  fi

  echo "%runscript finished"
